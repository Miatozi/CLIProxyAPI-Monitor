# CLIProxyAPI-Monitor v1.3.0 å®Œæ•´å®æ–½è®¡åˆ’

## æ‰§è¡Œæ—¶é—´
2026-01-15

## ç‰ˆæœ¬ç›®æ ‡
å®Œæˆ v1.3.0 æ¶æ„å‡çº§ï¼ŒåŒ…æ‹¬åç«¯é¢„èšåˆè¯»è·¯å¾„ã€å‰ç«¯ Server Components è¿ç§»ã€ç»„ä»¶æ‹†åˆ†ã€æ€§èƒ½ç›‘æ§ã€‚

---

## ğŸ“‹ æ–‡ä»¶æ¸…å•

### åç«¯ï¼ˆæ–°å¢/ä¿®æ”¹ï¼‰
| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `lib/queries/overviewAgg.ts` | æ–°å¢ | é¢„èšåˆè¯»è·¯å¾„ï¼ˆdailyAgg + hourlyAgg æ··åˆï¼‰ |
| `app/api/overview/route.ts` | ä¿®æ”¹ | å¼•å…¥ preagg å¼€å…³ + å®‰å…¨å›é€€ |
| `app/api/vitals/route.ts` | æ–°å¢ | Web Vitals æ¥æ”¶ API |
| `lib/db/schema.ts` | ä¿®æ”¹ | æ–°å¢ webVitals è¡¨ |
| `drizzle/0002_web_vitals.sql` | æ–°å¢ | è¿ç§»æ–‡ä»¶ |
| `lib/queries/vitals.ts` | æ–°å¢ | Vitals å†™å…¥å°è£… |

### å‰ç«¯ï¼ˆæ–°å¢/ä¿®æ”¹ï¼‰
| æ–‡ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `app/page.tsx` | é‡å†™ | Server Component + é¢„å–æ•°æ® |
| `app/dashboard/context/DashboardUIContext.tsx` | æ–°å¢ | å…¨å±æ¨¡å¼çŠ¶æ€ç®¡ç† |
| `app/hooks/useUrlFilters.ts` | æ–°å¢ | URL Search Params å°è£… |
| `app/dashboard/components/DashboardToolbar.tsx` | æ–°å¢ | æ—¥æœŸé€‰æ‹©å™¨ + ç­›é€‰å™¨ |
| `app/dashboard/components/charts/TrendChart.tsx` | æ–°å¢ | è¶‹åŠ¿å›¾ç»„ä»¶ |
| `app/dashboard/components/charts/HourlyChart.tsx` | æ–°å¢ | å°æ—¶ç»Ÿè®¡å›¾ç»„ä»¶ |
| `app/dashboard/components/charts/ModelPieChart.tsx` | æ–°å¢ | æ¨¡å‹åˆ†å¸ƒé¥¼å›¾ |
| `app/dashboard/components/tables/CostTable.tsx` | æ–°å¢ | è´¹ç”¨æ˜ç»†è¡¨ |
| `app/dashboard/components/LazyCharts.tsx` | æ–°å¢ | æ‡’åŠ è½½å¯¼å‡º |

---

## ğŸ—ï¸ å®æ–½æ­¥éª¤

### Step 1ï¼šæ•°æ®åº“è¿ç§»ï¼ˆWeb Vitals è¡¨ï¼‰
1. ä¿®æ”¹ `lib/db/schema.ts` å¢åŠ  `webVitals` è¡¨å®šä¹‰
2. åˆ›å»º `drizzle/0002_web_vitals.sql` è¿ç§»æ–‡ä»¶
3. è¿è¡Œ `pnpm run db:migrate`

**é¢„è®¡æ”¹åŠ¨**ï¼š2 ä¸ªæ–‡ä»¶ï¼Œ~50 è¡Œ

### Step 2ï¼šWeb Vitals API
1. åˆ›å»º `app/api/vitals/route.ts`ï¼ˆzod æ ¡éªŒ + é‡‡æ · + æ‰¹é‡å†™å…¥ï¼‰
2. åˆ›å»º `lib/queries/vitals.ts`ï¼ˆDB å†™å…¥å°è£…ï¼‰

**é¢„è®¡æ”¹åŠ¨**ï¼š2 ä¸ªæ–‡ä»¶ï¼Œ~150 è¡Œ

### Step 3ï¼šé¢„èšåˆè¯»è·¯å¾„
1. åˆ›å»º `lib/queries/overviewAgg.ts`ï¼ˆhybrid æŸ¥è¯¢ + è¿”å›ç»“æ„å¯¹é½ï¼‰
2. ä¿®æ”¹ `app/api/overview/route.ts`ï¼š
   - æ–°å¢ `ENABLE_PREAGG_READ` ç¯å¢ƒå˜é‡
   - æ–°å¢ `preagg=0/1` query è¦†ç›–
   - å¼‚å¸¸è‡ªåŠ¨å›é€€ raw
   - ç¼“å­˜é”®åŠ å…¥ mode

**é¢„è®¡æ”¹åŠ¨**ï¼š2 ä¸ªæ–‡ä»¶ï¼Œ~400 è¡Œ

### Step 4ï¼šå‰ç«¯ç»„ä»¶æ‹†åˆ†
1. åˆ›å»º `DashboardUIContext`ï¼ˆå…¨å±çŠ¶æ€ç®¡ç†ï¼‰
2. ä» `app/page.tsx` æå–å›¾è¡¨ç»„ä»¶ï¼š
   - `TrendChart.tsx`
   - `HourlyChart.tsx`
   - `ModelPieChart.tsx`
   - `CostTable.tsx`
3. åˆ›å»º `DashboardToolbar.tsx`ï¼ˆç­›é€‰å™¨ï¼‰
4. åˆ›å»º `useUrlFilters.ts`ï¼ˆURL çŠ¶æ€ç®¡ç†ï¼‰

**é¢„è®¡æ”¹åŠ¨**ï¼š7 ä¸ªæ–‡ä»¶ï¼Œ~600 è¡Œ

### Step 5ï¼šServer Components è¿ç§»
1. é‡å†™ `app/page.tsx` ä¸º async Server Component
2. åˆ é™¤ `useEffect` æ•°æ®è·å–
3. ç›´æ¥è°ƒç”¨ `getOverview()` / `getOverviewAgg()`
4. ä½¿ç”¨ `Suspense` åŒ…è£¹å›¾è¡¨åŒºåŸŸ

**é¢„è®¡æ”¹åŠ¨**ï¼š1 ä¸ªæ–‡ä»¶ï¼Œ~300 è¡Œï¼ˆå‡€å‡å°‘ ~2000 è¡Œï¼‰

### Step 6ï¼šæ€§èƒ½ä¼˜åŒ–
1. åˆ›å»º `LazyCharts.tsx`ï¼ˆnext/dynamic + ssr: falseï¼‰
2. æ·»åŠ  Framer Motion å…¥åœºåŠ¨ç”»
3. å‰ç«¯ Web Vitals ä¸ŠæŠ¥é›†æˆ

**é¢„è®¡æ”¹åŠ¨**ï¼š3 ä¸ªæ–‡ä»¶ï¼Œ~100 è¡Œ

### Step 7ï¼šéªŒè¯ä¸æµ‹è¯•
1. åŠŸèƒ½éªŒè¯ï¼šç­›é€‰ã€æ—¥æœŸèŒƒå›´ã€ä»·æ ¼ç¼–è¾‘ã€å…¨å±æ¨¡å¼
2. æ€§èƒ½éªŒè¯ï¼šå¯¹æ¯” raw vs agg æŸ¥è¯¢æ—¶é—´
3. æ„å»ºéªŒè¯ï¼š`pnpm build` + `pnpm lint`

---

## ğŸ“Š URL å‚æ•°è®¾è®¡

| å‚æ•° | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `days` | number | é¢„è®¾å¤©æ•°èŒƒå›´ | `14`ï¼ˆé»˜è®¤ï¼‰ |
| `start` | string | è‡ªå®šä¹‰å¼€å§‹æ—¥æœŸ | `2024-01-01` |
| `end` | string | è‡ªå®šä¹‰ç»“æŸæ—¥æœŸ | `2024-01-15` |
| `model` | string | æ¨¡å‹ç­›é€‰ | `gpt-4` |
| `route` | string | è·¯ç”±ç­›é€‰ | `openai-proxy` |
| `preagg` | 0/1 | é¢„èšåˆå¼€å…³ | `1` |

---

## ğŸ”§ ç¯å¢ƒå˜é‡

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `ENABLE_PREAGG_READ` | `true` | é¢„èšåˆè¯»è·¯å¾„å¼€å…³ |
| `VITALS_SAMPLE_RATE` | `0.2` | Web Vitals é‡‡æ ·ç‡ï¼ˆ20%ï¼‰ |

---

## âš ï¸ é£é™©ä¸ç¼“è§£

| é£é™© | ä¸¥é‡ç¨‹åº¦ | ç¼“è§£æªæ–½ |
|------|----------|----------|
| é¢„èšåˆå†å²æ•°æ®ç¼ºå£ | é«˜ | å‘å¸ƒå‰æ‰§è¡Œ backfill è„šæœ¬ |
| æ—¶åŒºä¸ä¸€è‡´ | ä¸­ | ç»Ÿä¸€ä½¿ç”¨ `Asia/Shanghai` |
| Server/Client è¾¹ç•Œå›å½’ | ä¸­ | æ¸è¿›å¼è¿ç§»ï¼Œä¿ç•™ fallback |
| bigint ç²¾åº¦æº¢å‡º | ä½ | çŸ­æœŸæ¥å—ï¼Œç›‘æ§ç´¯è®¡å€¼ |

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | é¢„æœŸä¼˜åŒ–å |
|------|--------|-----------|
| Overview API å“åº”æ—¶é—´ | 200-500ms | 50-100msï¼ˆ-75%ï¼‰ |
| é¦–å± JS Bundle | ~800KB | ~500KBï¼ˆ-37%ï¼‰ |
| é¦–å± LCP | 2.5s | 1.5sï¼ˆ-40%ï¼‰ |
| app/page.tsx è¡Œæ•° | 2594 è¡Œ | ~300 è¡Œï¼ˆ-88%ï¼‰ |

---

## ğŸ“ ä¼šè¯ä¿¡æ¯

- **Codex SESSION_ID**: `019bc0dd-b80c-73c1-8aa6-266e023423e0`
- **Gemini SESSION_ID**: `6e324285-9bf8-4996-8c4f-a3dc7345e545`

---

**å®¡æŸ¥äººå‘˜**ï¼šClaude (ç¼–æ’è€…)
**è§„åˆ’æ—¥æœŸ**ï¼š2026-01-15
**è§„åˆ’ç»“è®º**ï¼šå¾…ç”¨æˆ·æ‰¹å‡†
