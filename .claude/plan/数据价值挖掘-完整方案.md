# æ•°æ®ä»·å€¼æŒ–æ˜ - å®Œæ•´å®æ–½æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

**ç›®æ ‡**: å……åˆ†åˆ©ç”¨å·²æ”¶é›†ä½†æœªå¯è§†åŒ–çš„æ•°æ®,æå‡ç›‘æ§ä»·å€¼
**å‘¨æœŸ**: 2-3 å‘¨
**é£é™©**: ä½ (ä¸æ¶‰åŠæ¶æ„é‡æ„)

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–ç‚¹

### 1. Web Vitals æ€§èƒ½ç›‘æ§å¯è§†åŒ–
**ç°çŠ¶**: `web_vitals` è¡¨å·²æ”¶é›† LCP/CLS/INP æ•°æ®,ä½†æœªåœ¨ä»ªè¡¨ç›˜å±•ç¤º

**å®æ–½æ–¹æ¡ˆ**:
- P75 æ€§èƒ½æŒ‡æ ‡å¡ç‰‡ (RAG ç€è‰²: ç»¿/é»„/çº¢)
- æ€§èƒ½è¶‹åŠ¿å›¾è¡¨ (åŒ Y è½´: LCP/INP)
- æŒ‰é¡µé¢åˆ†ç»„çš„æ€§èƒ½æ’å

**æŠ€æœ¯æ–¹æ¡ˆ**:
```typescript
// API ç«¯ç‚¹
GET /api/vitals/summary         // P75 èšåˆ
GET /api/vitals/timeseries      // æ—¶é—´åºåˆ—

// å‰ç«¯ç»„ä»¶
<VitalsPanel>
  <VitalCard metric="LCP" value={2341} threshold={2500} />
  <VitalsTrendChart data={...} />
</VitalsPanel>
```

**æ•°æ®åº“ä¼˜åŒ–**:
```sql
-- æ–°å¢ç´¢å¼•
CREATE INDEX idx_vitals_perf ON web_vitals(pathname, name, created_at);
```

---

### 2. Token ä¸æˆæœ¬æ·±åº¦åˆ†æ
**ç°çŠ¶**: ä»…å±•ç¤ºæ€» Token æ•°,æœªæ‹†è§£ç»“æ„ (input/output/reasoning/cached)

**å®æ–½æ–¹æ¡ˆ**:
- Token ç»“æ„å †å é¢ç§¯å›¾
- æŒ‰æ¨¡å‹çš„æˆæœ¬è¶‹åŠ¿å¯¹æ¯”
- Route Ã— Model æˆæœ¬çƒ­åŠ›å›¾

**æŠ€æœ¯æ–¹æ¡ˆ**:
```typescript
// API ç«¯ç‚¹
GET /api/analytics/tokens/breakdown       // Token ç»“æ„
GET /api/analytics/cost/trend-by-model    // æˆæœ¬è¶‹åŠ¿

// å‰ç«¯ç»„ä»¶
<TokenStructureChart data={[
  { time, input, output, reasoning, cached }
]} />
<CostHeatmapTable routes={...} models={...} />
```

**æ•°æ®æº**:
- ä½¿ç”¨ `usage_hourly_agg` å’Œ `usage_daily_agg` èšåˆè¡¨
- å­—æ®µ: `input_tokens`, `output_tokens`, `reasoning_tokens`, `cache_write_tokens`

**æ•°æ®åº“ä¼˜åŒ–**:
```sql
-- æ–°å¢ç´¢å¼•
CREATE INDEX idx_hourly_model_time ON usage_hourly_agg(model, bucket_start);
CREATE INDEX idx_daily_route_time ON usage_daily_agg(route, day_start);
```

---

### 3. é”™è¯¯æ·±åº¦åˆ†æ
**ç°çŠ¶**: ä»…åœ¨ Explore é¡µé¢æŸ¥çœ‹åŸå§‹æ—¥å¿—,ç¼ºå°‘ç»Ÿè®¡åˆ†æ

**å®æ–½æ–¹æ¡ˆ**:
- æˆåŠŸ/å¤±è´¥å †å æŸ±çŠ¶å›¾ (æŒ‰æ—¶é—´)
- Top å¤±è´¥æ¨¡å‹/è·¯ç”±æ’è¡Œæ¦œ
- ä¸€é”®è·³è½¬åˆ° Explore é¡µé¢çš„é”™è¯¯ç­›é€‰è§†å›¾

**æŠ€æœ¯æ–¹æ¡ˆ**:
```typescript
// API ç«¯ç‚¹
GET /api/analytics/errors/timeseries  // æ—¶é—´åºåˆ—
GET /api/analytics/errors/top         // TopK ç»Ÿè®¡

// å‰ç«¯ç»„ä»¶
<StatusStackChart data={[
  { time, success: 95, error: 5 }
]} />
<TopFailuresList items={[
  { model, route, count, rate }
]} onClick={() => router.push('/explore?isError=true')} />
```

**æ•°æ®æº**:
- `usage_hourly_agg.success_count` vs `usage_hourly_agg.request_count`
- è®¡ç®—é”™è¯¯ç‡: `(request_count - success_count) / request_count`

**è”åŠ¨ä¼˜åŒ–**:
- ä¿®æ”¹ `app/explore/page.tsx` æ”¯æŒ `?isError=true` URL å‚æ•°
- è‡ªåŠ¨ç­›é€‰ `is_error = true` çš„è®°å½•

---

## ğŸ—ï¸ å®æ–½è®¡åˆ’

### Phase 1: Web Vitals æ€§èƒ½ç›‘æ§ (Week 1)

#### åç«¯ (Codex è´Ÿè´£)
1. **æ–°å¢ API è·¯ç”±**:
   - `app/api/vitals/summary/route.ts`
     - è®¡ç®— P75(LCP), P75(CLS), P75(INP)
     - åˆ†ç»„: å…¨å±€ / æŒ‰é¡µé¢
   - `app/api/vitals/timeseries/route.ts`
     - è¿”å›æŒ‰å°æ—¶/å¤©èšåˆçš„æ€§èƒ½æ•°æ®

2. **æ•°æ®åº“ä¼˜åŒ–**:
   ```sql
   -- scripts/migrate.mjs
   CREATE INDEX idx_vitals_perf ON web_vitals(pathname, name, created_at);
   ```

3. **æŸ¥è¯¢å±‚**:
   ```typescript
   // lib/queries/vitals.ts
   export async function getVitalsP75(pathname?: string) {
     // ä½¿ç”¨ percentile_cont(0.75) èšåˆ
   }
   ```

#### å‰ç«¯ (Gemini è´Ÿè´£)
1. **ç»„ä»¶å¼€å‘**:
   - `app/dashboard/components/vitals/VitalsPanel.tsx`
     - å®¹å™¨ç»„ä»¶,ç®¡ç†æ•°æ®è·å–
   - `app/dashboard/components/vitals/ui/VitalCard.tsx`
     - å•ä¸ªæŒ‡æ ‡å¡ç‰‡,RAG ç€è‰²é€»è¾‘
   - `app/dashboard/components/vitals/charts/VitalsTrendChart.tsx`
     - Recharts åŒ Y è½´æŠ˜çº¿å›¾

2. **æ ·å¼å¢å¼º**:
   ```typescript
   // tailwind.config.ts
   colors: {
     'chart-success': 'hsl(var(--chart-success))',
     'chart-warning': 'hsl(var(--chart-warning))',
     'chart-error': 'hsl(var(--chart-error))',
   }
   ```

3. **é›†æˆåˆ°ä¸»é¡µ**:
   ```tsx
   // app/page.tsx
   <VitalsPanel />
   ```

---

### Phase 2: Token ä¸æˆæœ¬åˆ†æ (Week 2)

#### åç«¯ (Codex è´Ÿè´£)
1. **æ–°å¢ API è·¯ç”±**:
   - `app/api/analytics/tokens/breakdown/route.ts`
     - è¿”å› Token ç»“æ„æ—¶é—´åºåˆ—
     - å­—æ®µ: `input_tokens`, `output_tokens`, `reasoning_tokens`, `cache_write_tokens`
   - `app/api/analytics/cost/trend-by-model/route.ts`
     - æŒ‰æ¨¡å‹åˆ†ç»„çš„æˆæœ¬è¶‹åŠ¿

2. **æ•°æ®åº“ä¼˜åŒ–**:
   ```sql
   CREATE INDEX idx_hourly_model_time ON usage_hourly_agg(model, bucket_start);
   CREATE INDEX idx_daily_route_time ON usage_daily_agg(route, day_start);
   ```

#### å‰ç«¯ (Gemini è´Ÿè´£)
1. **å›¾è¡¨ç»„ä»¶**:
   - `app/dashboard/components/charts/TokenStructureChart.tsx`
     - Recharts AreaChart (stacked)
     - 4 å±‚å †å : input/output/reasoning/cached
   - `app/dashboard/components/charts/CostTrendChart.tsx`
     - å¤šæ¡æŠ˜çº¿ (æ¯ä¸ªæ¨¡å‹ä¸€æ¡çº¿)

2. **çƒ­åŠ›å›¾è¡¨æ ¼**:
   - `app/dashboard/components/tables/CostHeatmapTable.tsx`
     - è¡Œ: è·¯ç”±, åˆ—: æ¨¡å‹
     - å•å…ƒæ ¼é¢œè‰²æ·±åº¦è¡¨ç¤ºæˆæœ¬

---

### Phase 3: é”™è¯¯æ·±åº¦åˆ†æ (Week 3)

#### åç«¯ (Codex è´Ÿè´£)
1. **æ–°å¢ API è·¯ç”±**:
   - `app/api/analytics/errors/timeseries/route.ts`
     - è®¡ç®—æ¯å°æ—¶/å¤©çš„æˆåŠŸç‡å’Œé”™è¯¯ç‡
   - `app/api/analytics/errors/top/route.ts`
     - TopK å¤±è´¥æ¨¡å‹/è·¯ç”±

2. **è”åŠ¨æ”¯æŒ**:
   - ä¿®æ”¹ `app/explore/page.tsx`
   - æ”¯æŒ `?isError=true` URL å‚æ•°è‡ªåŠ¨ç­›é€‰

#### å‰ç«¯ (Gemini è´Ÿè´£)
1. **å›¾è¡¨ç»„ä»¶**:
   - `app/dashboard/components/charts/StatusStackChart.tsx`
     - Recharts BarChart (stacked)
     - ç»¿è‰² (æˆåŠŸ) + çº¢è‰² (å¤±è´¥)

2. **åˆ—è¡¨ç»„ä»¶**:
   - `app/dashboard/components/tables/TopFailuresList.tsx`
     - æ˜¾ç¤º: æ¨¡å‹/è·¯ç”±, é”™è¯¯æ¬¡æ•°, é”™è¯¯ç‡
     - ç‚¹å‡»è·³è½¬åˆ° Explore é¡µé¢ç­›é€‰è§†å›¾

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶æ¸…å•

### åç«¯ (6 ä¸ªæ–‡ä»¶)
```
app/api/vitals/summary/route.ts
app/api/vitals/timeseries/route.ts
app/api/analytics/tokens/breakdown/route.ts
app/api/analytics/cost/trend-by-model/route.ts
app/api/analytics/errors/timeseries/route.ts
app/api/analytics/errors/top/route.ts
```

### å‰ç«¯ (7 ä¸ªæ–‡ä»¶)
```
app/dashboard/components/vitals/VitalsPanel.tsx
app/dashboard/components/vitals/ui/VitalCard.tsx
app/dashboard/components/vitals/charts/VitalsTrendChart.tsx
app/dashboard/components/charts/TokenStructureChart.tsx
app/dashboard/components/charts/CostTrendChart.tsx
app/dashboard/components/charts/StatusStackChart.tsx
app/dashboard/components/tables/CostHeatmapTable.tsx
app/dashboard/components/tables/TopFailuresList.tsx
```

### ä¿®æ”¹æ–‡ä»¶ (5 ä¸ª)
```
lib/queries/vitals.ts                  // æ–°å¢ P75 æŸ¥è¯¢å‡½æ•°
scripts/migrate.mjs                    // æ–°å¢ç´¢å¼•
app/explore/page.tsx                   // æ”¯æŒ ?isError=true
tailwind.config.ts                     // æ–°å¢è¯­ä¹‰åŒ–é¢œè‰²
app/page.tsx                           // é›†æˆæ–°ç»„ä»¶
```

---

## ğŸ¨ è®¾è®¡è§„èŒƒ

### RAG ç€è‰²é€»è¾‘
```typescript
const thresholds = {
  LCP: { good: 2500, poor: 4000 },  // ms
  CLS: { good: 0.1, poor: 0.25 },   // score
  INP: { good: 200, poor: 500 },    // ms
}

function getRagColor(metric: string, value: number) {
  const t = thresholds[metric]
  if (value <= t.good) return 'text-green-600'
  if (value <= t.poor) return 'text-yellow-600'
  return 'text-red-600'
}
```

### å›¾è¡¨é…è‰²
- **æˆåŠŸ**: `hsl(142, 76%, 36%)` (ç»¿è‰²)
- **è­¦å‘Š**: `hsl(48, 96%, 53%)` (é»„è‰²)
- **é”™è¯¯**: `hsl(0, 84%, 60%)` (çº¢è‰²)
- **Token ç±»å‹**:
  - Input: `hsl(221, 83%, 53%)` (è“è‰²)
  - Output: `hsl(142, 71%, 45%)` (ç»¿è‰²)
  - Reasoning: `hsl(280, 100%, 70%)` (ç´«è‰²)
  - Cached: `hsl(47, 100%, 62%)` (æ©™è‰²)

---

## âœ… éªŒè¯æ¸…å•

### Phase 1 éªŒè¯
- [ ] P75 æ€§èƒ½æŒ‡æ ‡å¡ç‰‡æ­£ç¡®ç€è‰²
- [ ] æ€§èƒ½è¶‹åŠ¿å›¾æ˜¾ç¤º LCP/INP åŒ Y è½´
- [ ] æŒ‰é¡µé¢åˆ†ç»„çš„æ€§èƒ½æ’åå‡†ç¡®

### Phase 2 éªŒè¯
- [ ] Token ç»“æ„å›¾æ­£ç¡®å †å  4 å±‚
- [ ] æˆæœ¬è¶‹åŠ¿å›¾å¤šæ¨¡å‹å¯¹æ¯”æ¸…æ™°
- [ ] çƒ­åŠ›å›¾é¢œè‰²æ·±åº¦ä¸æˆæœ¬å€¼åŒ¹é…

### Phase 3 éªŒè¯
- [ ] æˆåŠŸ/å¤±è´¥å †å å›¾æ¯”ä¾‹æ­£ç¡®
- [ ] Top å¤±è´¥åˆ—è¡¨æŒ‰é”™è¯¯ç‡é™åº
- [ ] ç‚¹å‡»è·³è½¬åˆ° Explore é¡µé¢ç­›é€‰ç”Ÿæ•ˆ

### æ€§èƒ½éªŒè¯
- [ ] æ‰€æœ‰ API å“åº”æ—¶é—´ < 500ms
- [ ] å›¾è¡¨æ¸²æŸ“æµç•… (60fps)
- [ ] ç´¢å¼•è¦†ç›–æ‰€æœ‰æŸ¥è¯¢ (ä½¿ç”¨ EXPLAIN ANALYZE éªŒè¯)

---

## ğŸš€ é¢„æœŸæ”¶ç›Š

1. **æ€§èƒ½ç›‘æ§**: å®æ—¶å‘ç°é¡µé¢æ€§èƒ½é€€åŒ–
2. **æˆæœ¬æ´å¯Ÿ**: è¯†åˆ«é«˜æˆæœ¬è·¯ç”±/æ¨¡å‹,ä¼˜åŒ–èµ„æºåˆ†é…
3. **é”™è¯¯è¿½è¸ª**: å¿«é€Ÿå®šä½é—®é¢˜æ¨¡å‹/è·¯ç”±,ç¼©çŸ­ MTTR

---

## ğŸ“… æ—¶é—´çº¿

- **Week 1**: Phase 1 å®Œæˆ + éªŒè¯
- **Week 2**: Phase 2 å®Œæˆ + éªŒè¯
- **Week 3**: Phase 3 å®Œæˆ + éªŒè¯ + æ•´ä½“æµ‹è¯•

---

## ğŸ‘¥ åä½œåˆ†å·¥

- **Codex**: è´Ÿè´£æ‰€æœ‰åç«¯ APIã€æ•°æ®åº“ä¼˜åŒ–ã€æŸ¥è¯¢å±‚
- **Gemini**: è´Ÿè´£æ‰€æœ‰å‰ç«¯ç»„ä»¶ã€å›¾è¡¨ã€æ ·å¼
- **Claude**: åè°ƒä»»åŠ¡ã€ä»£ç å®¡æŸ¥ã€é›†æˆæµ‹è¯•

---

*æœ¬æ–¹æ¡ˆåŸºäº v1.3.0 æ¶æ„,å……åˆ†åˆ©ç”¨ç°æœ‰èšåˆè¡¨å’Œ Server Components ä¼˜åŠ¿*
