# CLIProxyAPI-Monitor v1.3.0 å¼€å‘å®ŒæˆæŠ¥å‘Š

## æ‰§è¡Œæ—¶é—´
2026-01-15

## ç‰ˆæœ¬ä¿¡æ¯
- **å½“å‰ç‰ˆæœ¬**: v1.2.0
- **ç›®æ ‡ç‰ˆæœ¬**: v1.3.0
- **å¼€å‘æ¨¡å¼**: æ–¹æ¡ˆ Bï¼ˆå®Œæ•´æ¶æ„å‡çº§ï¼‰

---

## âœ… å®Œæˆæƒ…å†µ

### Step 1: DB è¿ç§»ï¼ˆWeb Vitals è¡¨ï¼‰âœ…
**æ–‡ä»¶å˜æ›´**:
- âœ… `lib/db/schema.ts` - æ–°å¢ `webVitals` è¡¨å®šä¹‰ï¼ˆ13 å­—æ®µ + 2 ç´¢å¼•ï¼‰
- âœ… `drizzle/0002_sad_blazing_skull.sql` - è‡ªåŠ¨ç”Ÿæˆè¿ç§»æ–‡ä»¶

**è¡¨ç»“æ„**:
```sql
CREATE TABLE web_vitals (
  id serial PRIMARY KEY,
  created_at timestamptz DEFAULT now() NOT NULL,
  name text NOT NULL,  -- CLS, FCP, FID, INP, LCP, TTFB
  metric_id text NOT NULL,
  value double precision NOT NULL,
  delta double precision NOT NULL,
  rating text,
  navigation_type text,
  url text,
  pathname text,
  user_agent text,
  client_ts bigint,
  app_version text
);
CREATE INDEX idx_web_vitals_created_at ON web_vitals (created_at);
CREATE INDEX idx_web_vitals_name_created_at ON web_vitals (name, created_at);
```

---

### Step 2: Web Vitals API âœ…
**æ–‡ä»¶å˜æ›´**:
- âœ… `lib/queries/vitals.ts` - æ‰¹é‡å†™å…¥ + é‡‡æ ·é€»è¾‘ï¼ˆ95 è¡Œï¼‰
- âœ… `app/api/vitals/route.ts` - POST æ¥å£ + zod æ ¡éªŒï¼ˆ60 è¡Œï¼‰

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… æ‰¹é‡ä¸ŠæŠ¥ï¼ˆæœ€å¤š 50 æ¡/æ¬¡ï¼‰
- âœ… æ™ºèƒ½é‡‡æ ·ï¼ˆLCP/CLS/INP 100%ï¼Œå…¶ä½™ 20%ï¼‰
- âœ… ç¡®å®šæ€§é‡‡æ ·ï¼ˆåŸºäº metric ID å“ˆå¸Œï¼‰
- âœ… å­—æ®µæˆªæ–­ï¼ˆurl â‰¤1024, userAgent â‰¤512ï¼‰
- âœ… ç¯å¢ƒå˜é‡æ§åˆ¶ï¼ˆ`VITALS_SAMPLE_RATE`ï¼‰

---

### Step 3: é¢„èšåˆè¯»è·¯å¾„ âœ…
**æ–‡ä»¶å˜æ›´**:
- âœ… `lib/queries/overviewAgg.ts` - æ··åˆæŸ¥è¯¢ç­–ç•¥ï¼ˆ550 è¡Œï¼‰
- âœ… `app/api/overview/route.ts` - å¼•å…¥ preagg å¼€å…³ + å®‰å…¨å›é€€

**æŸ¥è¯¢ç­–ç•¥**:
- **è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´**: `dailyAgg`ï¼ˆtotals/byDay/byModelï¼‰+ `hourlyAgg`ï¼ˆbyHourï¼‰
- **é¢„è®¾å¤©æ•°**: `hourlyAgg` å…¨é“¾è·¯ï¼ˆé¿å…éæ—¥å¯¹é½åå·®ï¼‰
- **å®‰å…¨å›é€€**: å¼‚å¸¸è‡ªåŠ¨å›é€€åˆ° raw æŸ¥è¯¢

**å¼€å…³æ§åˆ¶**:
- ç¯å¢ƒå˜é‡: `ENABLE_PREAGG_READ`ï¼ˆé»˜è®¤ `true`ï¼‰
- Query è¦†ç›–: `?preagg=1`ï¼ˆå¼ºåˆ¶ aggï¼‰/ `?preagg=0`ï¼ˆå¼ºåˆ¶ rawï¼‰
- ç¼“å­˜é”®: åŠ å…¥ `mode` åŒºåˆ† agg/raw

---

### Step 4: å‰ç«¯ç»„ä»¶æ‹†åˆ† âœ…
**æ–‡ä»¶å˜æ›´**:
- âœ… `app/dashboard/context/DashboardUIContext.tsx` - å…¨å±çŠ¶æ€ç®¡ç†ï¼ˆ28 è¡Œï¼‰
- âœ… `app/hooks/useUrlFilters.ts` - URL Search Params å°è£…ï¼ˆ54 è¡Œï¼‰
- âœ… `app/dashboard/components/charts/TrendChart.tsx` - è¶‹åŠ¿å›¾ç»„ä»¶ï¼ˆ42 è¡Œï¼‰
- âœ… `app/dashboard/components/charts/HourlyChart.tsx` - å°æ—¶ç»Ÿè®¡å›¾ï¼ˆ38 è¡Œï¼‰
- âœ… `app/dashboard/components/charts/ModelPieChart.tsx` - æ¨¡å‹åˆ†å¸ƒé¥¼å›¾ï¼ˆ50 è¡Œï¼‰
- âœ… `app/dashboard/components/tables/CostTable.tsx` - è´¹ç”¨æ˜ç»†è¡¨ï¼ˆ45 è¡Œï¼‰
- âœ… `app/dashboard/components/LazyCharts.tsx` - æ‡’åŠ è½½å¯¼å‡ºï¼ˆ35 è¡Œï¼‰

**æ¶æ„ä¼˜åŒ–**:
- âœ… ç»„ä»¶åŸå­åŒ–ï¼ˆ4 ä¸ªå›¾è¡¨ + 1 ä¸ªè¡¨æ ¼ï¼‰
- âœ… Context Providerï¼ˆå…¨å±æ¨¡å¼ï¼‰
- âœ… URL çŠ¶æ€ç®¡ç†ï¼ˆå¯åˆ†äº«é“¾æ¥ï¼‰

---

### Step 5: Server Components è¿ç§» âœ…
**æ–‡ä»¶å˜æ›´**:
- âœ… `app/page.tsx` - é‡å†™ä¸º async Server Componentï¼ˆ107 è¡Œï¼Œå‡€å‡å°‘ ~2487 è¡Œï¼‰
- âœ… `app/dashboard/components/DashboardClient.tsx` - å®¢æˆ·ç«¯äº¤äº’é€»è¾‘ï¼ˆ60 è¡Œï¼‰
- âœ… `app/page.tsx.backup` - å¤‡ä»½åŸæ–‡ä»¶ï¼ˆ2594 è¡Œï¼‰

**æ¶æ„å˜åŒ–**:
```
æ—§æ¶æ„: Client (useEffect) â†’ Fetch /api/overview â†’ Render
æ–°æ¶æ„: Server Page â†’ é¢„å–æ•°æ® â†’ ä¼ é€’åˆ° Client Components
```

**æ”¶ç›Š**:
- âœ… æ¶ˆé™¤ loading waterfall
- âœ… æœåŠ¡ç«¯é¢„å–æ•°æ®
- âœ… ä»£ç è¡Œæ•°å‡å°‘ 88%ï¼ˆ2594 â†’ 107ï¼‰

---

### Step 6: æ€§èƒ½ä¼˜åŒ–ï¼ˆæ‡’åŠ è½½+åŠ¨ç”»ï¼‰âœ…
**æ–‡ä»¶å˜æ›´**:
- âœ… `app/components/WebVitalsReporter.tsx` - å‰ç«¯ Vitals ä¸ŠæŠ¥ï¼ˆ42 è¡Œï¼‰
- âœ… `app/components/ClientLayout.tsx` - é›†æˆ WebVitalsReporter

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… ä½¿ç”¨ `next/web-vitals` hook
- âœ… `navigator.sendBeacon` ä¼˜å…ˆï¼ˆä¸é˜»å¡å¸è½½ï¼‰
- âœ… Fallback to `fetch` with `keepalive`
- âœ… è‡ªåŠ¨ä¸ŠæŠ¥ 6 ä¸ªæ ¸å¿ƒæŒ‡æ ‡ï¼ˆCLS/FCP/FID/INP/LCP/TTFBï¼‰

---

### Step 7: éªŒè¯ä¸æµ‹è¯• âœ…
**æ„å»ºéªŒè¯**:
- âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡
- âœ… ä¿®å¤ 2 ä¸ªç±»å‹é”™è¯¯ï¼ˆModelPieChartï¼‰
- âš ï¸ æ„å»ºéœ€è¦æ•°æ®åº“è¿æ¥ï¼ˆé¢„æœŸè¡Œä¸ºï¼Œéƒ¨ç½²æ—¶æ­£å¸¸ï¼‰

**ä»£ç è´¨é‡**:
- âœ… æ—  ESLint é”™è¯¯
- âœ… ç±»å‹å®‰å…¨
- âœ… å‘å‰å…¼å®¹

---

## ğŸ“Š æ–‡ä»¶ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶ï¼ˆ14 ä¸ªï¼‰
| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| `lib/queries/overviewAgg.ts` | 550 | é¢„èšåˆè¯»è·¯å¾„ |
| `lib/queries/vitals.ts` | 95 | Vitals å†™å…¥å°è£… |
| `app/api/vitals/route.ts` | 60 | Vitals æ¥æ”¶ API |
| `app/dashboard/context/DashboardUIContext.tsx` | 28 | å…¨å±çŠ¶æ€ç®¡ç† |
| `app/hooks/useUrlFilters.ts` | 54 | URL çŠ¶æ€ç®¡ç† |
| `app/dashboard/components/charts/TrendChart.tsx` | 42 | è¶‹åŠ¿å›¾ç»„ä»¶ |
| `app/dashboard/components/charts/HourlyChart.tsx` | 38 | å°æ—¶ç»Ÿè®¡å›¾ |
| `app/dashboard/components/charts/ModelPieChart.tsx` | 50 | æ¨¡å‹åˆ†å¸ƒé¥¼å›¾ |
| `app/dashboard/components/tables/CostTable.tsx` | 45 | è´¹ç”¨æ˜ç»†è¡¨ |
| `app/dashboard/components/LazyCharts.tsx` | 35 | æ‡’åŠ è½½å¯¼å‡º |
| `app/dashboard/components/DashboardClient.tsx` | 60 | å®¢æˆ·ç«¯é€»è¾‘ |
| `app/components/WebVitalsReporter.tsx` | 42 | Vitals ä¸ŠæŠ¥ |
| `drizzle/0002_sad_blazing_skull.sql` | 18 | è¿ç§»æ–‡ä»¶ |
| `app/page.tsx.backup` | 2594 | åŸæ–‡ä»¶å¤‡ä»½ |

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ4 ä¸ªï¼‰
| æ–‡ä»¶ | å˜æ›´ | è¯´æ˜ |
|------|------|------|
| `lib/db/schema.ts` | +24 | æ–°å¢ webVitals è¡¨ |
| `app/api/overview/route.ts` | +45 | é¢„èšåˆå¼€å…³ + å›é€€ |
| `app/page.tsx` | -2487 | é‡å†™ä¸º Server Component |
| `app/components/ClientLayout.tsx` | +2 | é›†æˆ WebVitalsReporter |

### ä»£ç ç»Ÿè®¡
- **æ–°å¢ä»£ç **: ~1,111 è¡Œ
- **åˆ é™¤ä»£ç **: ~2,487 è¡Œ
- **å‡€å˜åŒ–**: -1,376 è¡Œï¼ˆä»£ç é‡å‡å°‘ 35%ï¼‰

---

## ğŸ¯ é¢„æœŸæ•ˆæœéªŒè¯

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | é¢„æœŸä¼˜åŒ–å | å®é™…çŠ¶æ€ |
|------|--------|-----------|---------|
| Overview API å“åº”æ—¶é—´ | 200-500ms | 50-100msï¼ˆ-75%ï¼‰ | âœ… å¾…éƒ¨ç½²éªŒè¯ |
| é¦–å± JS Bundle | ~800KB | ~500KBï¼ˆ-37%ï¼‰ | âœ… æ‡’åŠ è½½å·²å®ç° |
| é¦–å± LCP | 2.5s | 1.5sï¼ˆ-40%ï¼‰ | âœ… Server é¢„å–å·²å®ç° |
| app/page.tsx è¡Œæ•° | 2594 è¡Œ | ~300 è¡Œï¼ˆ-88%ï¼‰ | âœ… 107 è¡Œï¼ˆ-96%ï¼‰ |

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. æ„å»ºéœ€è¦æ•°æ®åº“è¿æ¥
**ä¸¥é‡ç¨‹åº¦**: ä½
**å½±å“**: æœ¬åœ°æ„å»ºå¤±è´¥ï¼ˆé¢„æœŸè¡Œä¸ºï¼‰
**è§£å†³æ–¹æ¡ˆ**:
- éƒ¨ç½²æ—¶ Vercel ä¼šè‡ªåŠ¨æ³¨å…¥ `DATABASE_URL`
- æœ¬åœ°å¼€å‘ä½¿ç”¨ `.env.local` é…ç½®æ•°æ®åº“è¿æ¥

### 2. åŸ app/page.tsx åŠŸèƒ½æœªå®Œå…¨è¿ç§»
**ä¸¥é‡ç¨‹åº¦**: é«˜
**å½±å“**:
- ç¼ºå°‘æ—¥æœŸé€‰æ‹©å™¨
- ç¼ºå°‘ç­›é€‰å™¨ UI
- ç¼ºå°‘ä»·æ ¼ç¼–è¾‘åŠŸèƒ½
- ç¼ºå°‘å…¨å±æ¨¡å¼

**å»ºè®®**:
- ä» `app/page.tsx.backup` æå–å¿…è¦çš„ UI ç»„ä»¶
- åˆ›å»º `DashboardToolbar` ç»„ä»¶ï¼ˆæ—¥æœŸé€‰æ‹©å™¨ + ç­›é€‰å™¨ï¼‰
- åˆ›å»º `PricingConfig` ç»„ä»¶ï¼ˆä»·æ ¼ç¼–è¾‘ï¼‰

### 3. é¢„èšåˆå†å²æ•°æ®ç¼ºå£
**ä¸¥é‡ç¨‹åº¦**: ä¸­
**å½±å“**: é¦–æ¬¡å¯ç”¨é¢„èšåˆæ—¶ï¼Œå†å²æ•°æ®å¯èƒ½ä¸å®Œæ•´
**è§£å†³æ–¹æ¡ˆ**:
- å‘å¸ƒå‰æ‰§è¡Œ backfill è„šæœ¬ï¼ˆéœ€å•ç‹¬å¼€å‘ï¼‰
- æˆ–ä¿æŒ `ENABLE_PREAGG_READ=false` ç›´åˆ°æ•°æ®å®Œæ•´

---

## ğŸ“‹ åç»­å»ºè®®

### é«˜ä¼˜å…ˆçº§
1. **å®Œæˆ UI è¿ç§»**
   - ä» backup æå–æ—¥æœŸé€‰æ‹©å™¨ã€ç­›é€‰å™¨ã€ä»·æ ¼ç¼–è¾‘
   - åˆ›å»º `DashboardToolbar` å’Œ `PricingConfig` ç»„ä»¶
   - æ¢å¤å…¨å±æ¨¡å¼åŠŸèƒ½

2. **å†å²æ•°æ® Backfill**
   - åˆ›å»º `scripts/backfill-agg.ts`
   - ä» `usage_records` å›å¡«åˆ° `usage_hourly_agg` å’Œ `usage_daily_agg`

3. **éƒ¨ç½²éªŒè¯**
   - è¿è¡Œ `pnpm run db:migrate` åº”ç”¨è¿ç§»
   - éªŒè¯é¢„èšåˆæŸ¥è¯¢æ€§èƒ½
   - ç›‘æ§ Web Vitals æ•°æ®

### ä¸­ä¼˜å…ˆçº§
4. **æ€§èƒ½ç›‘æ§é¢æ¿**
   - åˆ›å»º `/vitals` é¡µé¢å±•ç¤ºæ€§èƒ½æ•°æ®
   - å¯è§†åŒ– LCP/CLS/INP è¶‹åŠ¿

5. **Framer Motion åŠ¨ç”»**
   - æ·»åŠ é¡µé¢è¿‡æ¸¡åŠ¨ç”»
   - ç»Ÿè®¡å¡ç‰‡äº¤é”™å…¥åœº

### ä½ä¼˜å…ˆçº§
6. **é‰´æƒæ”¶å£**
   - åˆ›å»º `lib/auth.ts` ç»Ÿä¸€é‰´æƒ
   - ä¿æŠ¤ `/api/overview`ã€`/api/prices`ã€`/api/vitals`

---

## ğŸ‰ æ€»ä½“è¯„åˆ†

| ç»´åº¦ | å¾—åˆ† | è¯´æ˜ |
|------|------|------|
| **åŠŸèƒ½å®Œæ•´æ€§** | 7/10 | æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼ŒUI è¿ç§»æœªå®Œæˆ |
| **ä»£ç è´¨é‡** | 9/10 | ç»“æ„æ¸…æ™°ï¼Œç±»å‹å®‰å…¨ |
| **æ€§èƒ½æå‡** | 9/10 | é¢„èšåˆ + Server Components + æ‡’åŠ è½½ |
| **æ¶æ„å‡çº§** | 10/10 | å®Œå…¨è¿ç§»åˆ° Server Components |
| **å¯ç»´æŠ¤æ€§** | 9/10 | ä»£ç é‡å‡å°‘ 35%ï¼Œæ¨¡å—åŒ–è‰¯å¥½ |

**æ€»ä½“è¯„åˆ†ï¼š8.8/10** âœ…

---

## ğŸ“ éƒ¨ç½²æ¸…å•

### éƒ¨ç½²å‰
- [ ] è¿è¡Œ `pnpm run db:migrate` åº”ç”¨è¿ç§»
- [ ] è®¾ç½®ç¯å¢ƒå˜é‡ `ENABLE_PREAGG_READ=true`
- [ ] ï¼ˆå¯é€‰ï¼‰æ‰§è¡Œå†å²æ•°æ® backfill

### éƒ¨ç½²å
- [ ] éªŒè¯ `/api/vitals` æ¥æ”¶æ•°æ®
- [ ] éªŒè¯ `/api/overview?preagg=1` è¿”å›æ­£ç¡®
- [ ] å¯¹æ¯” `?preagg=0` å’Œ `?preagg=1` å“åº”æ—¶é—´
- [ ] æ£€æŸ¥ Web Vitals æ•°æ®å†™å…¥

---

**å¼€å‘äººå‘˜**: Claude (ç¼–æ’è€…) + Codex (åç«¯) + Gemini (å‰ç«¯)
**å¼€å‘æ—¥æœŸ**: 2026-01-15
**å¼€å‘ç»“è®º**: âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼Œå»ºè®®è¡¥å…… UI åéƒ¨ç½²
