# CLIProxyAPI-Monitor v1.3.1 实施计划

## 执行时间
2026-01-15

## 版本目标
完成 v1.3.0 遗留功能：UI 迁移 + 历史数据 Backfill

---

## 📋 文件清单

### 前端（新增/修改）
| 文件 | 类型 | 说明 |
|------|------|------|
| `app/dashboard/components/ui/ComboBox.tsx` | 新增 | 通用下拉组件（从 backup 提取） |
| `app/dashboard/components/DashboardToolbar.tsx` | 新增 | 日期选择器 + 筛选器 |
| `app/dashboard/components/PricingConfig.tsx` | 新增 | 价格管理（CRUD） |
| `app/dashboard/components/FullscreenContainer.tsx` | 新增 | 全屏图表容器 |
| `app/dashboard/components/DashboardClient.tsx` | 修改 | 整合上述组件 |
| `app/dashboard/components/charts/*.tsx` | 修改 | 增加 `onMaximize` 支持 |

### 后端（新增/修改）
| 文件 | 类型 | 说明 |
|------|------|------|
| `scripts/backfill-agg.mjs` | 新增 | 历史数据回填脚本 |
| `package.json` | 修改 | 新增 `db:backfill-agg` 脚本 |
| `README.md` | 修改 | 补充 Backfill 使用说明 |

---

## 🎯 前端实施计划

### 组件接口设计

#### 1. DashboardToolbar
```typescript
interface DashboardToolbarProps {
  initialFilters: {
    days?: number;
    start?: string;
    end?: string;
    model?: string;
    route?: string;
  };
  modelOptions: string[];
  routeOptions: string[];
  onRefresh: () => void;
  isRefreshing: boolean;
  lastSyncTime: Date | null;
}
```

**功能**：
- 预设日期选项（7/14/30 天）
- 自定义日期范围选择器
- 模型/路由筛选器（ComboBox）
- 刷新按钮

#### 2. PricingConfig
```typescript
interface PricingConfigProps {
  onPriceChange?: () => void;
}
```

**功能**：
- 价格列表展示
- 添加/编辑/删除价格
- 模态框表单

#### 3. FullscreenContainer
```typescript
interface FullscreenContainerProps {
  data: UsageOverview;
}
```

**功能**：
- 监听 `DashboardUIContext.fullscreenChart`
- 全屏模态框渲染图表
- ESC 键关闭

#### 4. 图表组件增强
```typescript
interface ChartProps {
  // ... 现有 props
  onMaximize?: () => void; // 新增
}
```

### 状态管理策略

| 状态域 | 管理方式 | 实现 |
|--------|----------|------|
| 筛选状态（日期/模型） | URL Search Params | `useUrlFilters` |
| 全屏状态 | Context | `DashboardUIContext` |
| 价格数据 | Client State | `PricingConfig` 内部 |
| UI 交互（弹窗） | Local State | 各组件内部 |

### 实施步骤

1. **基础组件提取**
   - 创建 `ComboBox.tsx`（从 backup L2437 提取）
   - 确保 `Modal.tsx` 可用

2. **DashboardToolbar 开发**
   - 创建 `DashboardToolbar.tsx`
   - 集成 `useUrlFilters`
   - 迁移日期选择器逻辑

3. **图表组件增强**
   - 修改 `charts/*.tsx` 添加 Maximize 按钮
   - 迁移 Tooltip 和 Axis 格式化逻辑

4. **PricingConfig 迁移**
   - 创建 `PricingConfig.tsx`
   - 迁移 CRUD 逻辑

5. **FullscreenContainer 开发**
   - 创建 `FullscreenContainer.tsx`
   - 监听 Context 状态

6. **集成到 DashboardClient**
   - 添加 `DashboardToolbar`
   - 添加 `PricingConfig`
   - 添加 `FullscreenContainer`

---

## 🔧 后端实施计划

### 脚本接口设计

#### CLI 参数
```bash
node scripts/backfill-agg.mjs \
  --from 2024-01-01 \
  --to 2024-12-31 \
  --only both \
  --chunk-hours 24 \
  --chunk-days 7 \
  --dry-run
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--from` | YYYY-MM-DD | 必填 | 开始日期（Asia/Shanghai） |
| `--to` | YYYY-MM-DD | 必填 | 结束日期（开区间） |
| `--only` | hourly/daily/both | both | 聚合类型 |
| `--chunk-hours` | number | 24 | 小时聚合批次大小 |
| `--chunk-days` | number | 7 | 日聚合批次大小 |
| `--dry-run` | boolean | false | 仅输出计划 |
| `--sleep-ms` | number | 0 | 批次间延迟 |
| `--lock-timeout-ms` | number | 2000 | 锁超时 |
| `--statement-timeout-ms` | number | 60000 | 语句超时 |

### SQL 查询设计（覆盖式 Upsert）

#### Hourly Aggregation
```sql
INSERT INTO usage_hourly_agg (
  bucket_start, route, model,
  total_tokens, input_tokens, output_tokens, reasoning_tokens, cached_tokens,
  total_requests, success_count, failure_count,
  created_at, updated_at
)
SELECT
  date_trunc('hour', occurred_at at time zone 'Asia/Shanghai') at time zone 'Asia/Shanghai' AS bucket_start,
  route,
  model,
  coalesce(sum(total_tokens), 0)::bigint,
  coalesce(sum(input_tokens), 0)::bigint,
  coalesce(sum(output_tokens), 0)::bigint,
  coalesce(sum(reasoning_tokens), 0)::bigint,
  coalesce(sum(cached_tokens), 0)::bigint,
  coalesce(sum(total_requests), 0)::bigint,
  coalesce(sum(success_count), 0)::bigint,
  coalesce(sum(failure_count), 0)::bigint,
  now(),
  now()
FROM usage_records
WHERE occurred_at >= $1 AND occurred_at < $2
GROUP BY 1, route, model
ON CONFLICT (bucket_start, route, model) DO UPDATE SET
  total_tokens     = EXCLUDED.total_tokens,
  input_tokens     = EXCLUDED.input_tokens,
  output_tokens    = EXCLUDED.output_tokens,
  reasoning_tokens = EXCLUDED.reasoning_tokens,
  cached_tokens    = EXCLUDED.cached_tokens,
  total_requests   = EXCLUDED.total_requests,
  success_count    = EXCLUDED.success_count,
  failure_count    = EXCLUDED.failure_count,
  updated_at       = now();
```

#### Daily Aggregation
同结构，桶字段改为 `day_start`，桶表达式用 `date_trunc('day', ...)`。

### 错误处理与日志

**启动阶段**：
- 参数校验（范围合法、chunk > 0）
- 失败返回退出码 `2`

**执行阶段**：
- 按 chunk 事务化执行
- 失败：`ROLLBACK` + 记录错误
- `--continue-on-error` 时继续，否则退出码 `1`

**可观测性**：
- 每个 chunk 输出进度（时间、模式、耗时、影响行数）
- `--dry-run` 输出 chunk 计划和统计

### 实施步骤

1. **复制 DB 初始化模式**
   - 从 `scripts/migrate.mjs` 复制连接逻辑

2. **CLI 参数解析**
   - 实现 `--help`
   - 不引入新依赖

3. **时间范围解析**
   - `--from/--to` 的 Shanghai 日边界转换
   - `--start-ts/--end-ts` 的 ISO 解析

4. **Chunk 迭代器**
   - hourly：步长 `chunk-hours`
   - daily：步长 `chunk-days`

5. **覆盖式 Upsert 函数**
   - hourly 和 daily 各一个

6. **Dry-run 分支**
   - 统计查询

7. **超时与节流**
   - 事务内 `SET LOCAL`
   - `sleep-ms` 节流

8. **文档更新**
   - `package.json` 添加脚本
   - `README.md` 补充说明

---

## 📊 预期效果

### 前端
- ✅ 恢复日期选择器（预设 + 自定义）
- ✅ 恢复筛选器（模型/路由）
- ✅ 恢复价格编辑功能
- ✅ 恢复全屏模式
- ✅ 保持 Server Components 架构

### 后端
- ✅ 历史数据完整回填
- ✅ 幂等执行（可重复运行）
- ✅ 分批处理（避免锁表）
- ✅ 错误处理与日志

---

## ⚠️ 风险与缓解

| 风险 | 严重程度 | 缓解措施 |
|------|----------|----------|
| Backfill 重复执行导致数据错误 | 高 | 使用覆盖式 Upsert（幂等） |
| 大批次锁表影响线上 | 中 | 分批处理 + 节流 |
| 时区不一致 | 中 | 统一使用 Asia/Shanghai |
| UI 组件提取遗漏 | 低 | 对照 backup 逐一验证 |

---

## 📝 部署清单

### 部署前
- [ ] 运行 `node scripts/backfill-agg.mjs --dry-run` 验证
- [ ] 执行 Backfill（建议 off-peak）
- [ ] 验证聚合表数据完整性

### 部署后
- [ ] 验证日期选择器功能
- [ ] 验证筛选器功能
- [ ] 验证价格编辑功能
- [ ] 验证全屏模式

---

**规划人员**: Claude (编排者) + Codex (后端) + Gemini (前端)
**规划日期**: 2026-01-15
**规划结论**: 待用户批准
